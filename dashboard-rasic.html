<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard RASIC Halotech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .card-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .metric-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .kpi-number {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1;
    }
    @media (max-width: 768px) {
      .kpi-number { font-size: 2rem; }
    }
    .notificacion-toast {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    /* Estilos espec√≠ficos para impresi√≥n del dashboard */
    @media print {
      .no-print {
        display: none !important;
      }
      
      body {
        background: white !important;
      }
      
      .card-gradient {
        background: #4F46E5 !important;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
      }
      
      .metric-card {
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #ddd !important;
      }
      
      .bg-white {
        border: 1px solid #ddd !important;
      }
      
      canvas {
        max-width: 100% !important;
        height: auto !important;
      }
      
      .bg-green-100 { background-color: #dcfce7 !important; }
      .bg-yellow-100 { background-color: #fef3c7 !important; }
      .bg-red-100 { background-color: #fecaca !important; }
      
      .bg-red-200 { background-color: #fecaca !important; }
      .bg-yellow-200 { background-color: #fef3c7 !important; }
      .bg-green-200 { background-color: #dcfce7 !important; }
      
      .text-red-800 { color: #991b1b !important; }
      .text-yellow-800 { color: #92400e !important; }
      .text-green-800 { color: #166534 !important; }
    }

    /* NUEVOS ESTILOS - Estilos para el modal de exportaci√≥n */
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .export-option {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .export-option:hover {
      background-color: #f3f4f6;
      border-color: #3b82f6;
    }
    
    .export-option.selected {
      background-color: #dbeafe;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }
    /* Estilos para el modal de configuraci√≥n de alertas */
.alert-config-option {
  transition: all 0.2s ease;
  cursor: pointer;
}

.alert-config-option:hover {
  background-color: #f9fafb;
}

.alert-config-option.active {
  background-color: #fef3c7;
  border-color: #f59e0b;
}

.switch {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 24px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #10b981;
}

input:checked + .slider:before {
  transform: translateX(24px);
}
/* Estilos para la vista de calendario */
.calendario-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

.calendario-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.calendario-nav-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  padding: 0.5rem;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}

.calendario-nav-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

.calendario-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  background: #e5e7eb;
}

.calendario-dia-header {
  background: #f9fafb;
  padding: 0.75rem;
  text-align: center;
  font-weight: 600;
  font-size: 0.875rem;
  color: #374151;
}

.calendario-dia {
  background: white;
  min-height: 120px;
  padding: 0.5rem;
  position: relative;
  cursor: pointer;
  transition: background 0.2s;
}

.calendario-dia:hover {
  background: #f9fafb;
}

.calendario-dia.otro-mes {
  background: #f3f4f6;
  color: #9ca3af;
}

.calendario-dia.hoy {
  background: #dbeafe;
  border: 2px solid #3b82f6;
}

.calendario-dia-numero {
  font-weight: 600;
  margin-bottom: 0.25rem;
  font-size: 0.875rem;
}

.calendario-tarea {
  background: #e5e7eb;
  border-radius: 4px;
  padding: 2px 4px;
  margin-bottom: 2px;
  font-size: 0.75rem;
  line-height: 1.2;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.calendario-tarea.verde {
  background: #dcfce7;
  color: #166534;
  border-left: 3px solid #10b981;
}

.calendario-tarea.amarillo {
  background: #fef3c7;
  color: #92400e;
  border-left: 3px solid #f59e0b;
}

.calendario-tarea.rojo {
  background: #fecaca;
  color: #991b1b;
  border-left: 3px solid #ef4444;
}

.calendario-tarea.azul {
  background: #dbeafe;
  color: #1e40af;
  border-left: 3px solid #3b82f6;
}

.calendario-mas-tareas {
  font-size: 0.75rem;
  color: #6b7280;
  font-style: italic;
  margin-top: 2px;
}

@media (max-width: 768px) {
  .calendario-dia {
    min-height: 80px;
    padding: 0.25rem;
  }
  
  .calendario-tarea {
    font-size: 0.625rem;
    padding: 1px 2px;
  }
  
  .calendario-dia-numero {
    font-size: 0.75rem;
  }
}
</style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="card-gradient text-white p-6 shadow-lg">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-3xl font-bold mb-2">üìä Dashboard RASIC Halotech</h1>
      <p class="opacity-90">An√°lisis y m√©tricas de tareas - <span id="fechaActualizacion"></span></p>
    </div>
  </header>
  <!-- Controles -->
<div class="max-w-7xl mx-auto p-4">
  <div class="flex flex-wrap gap-3 justify-between items-center mb-6 no-print">
    <div class="flex flex-wrap gap-2">
      <button id="btnActualizar" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
        üîÑ Actualizar Dashboard
      </button>
      <button id="btnCargarDatos" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
        üìÇ Cargar Datos de Prueba
      </button>
      <button id="btnImprimir" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
        üñ®Ô∏è Imprimir Dashboard
      </button>
      <!-- NUEVO: Bot√≥n de exportaci√≥n -->
      <button id="btnExportar" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
      üì• Exportar Datos
    </button>
      <!-- NUEVO: Bot√≥n de configuraci√≥n de alertas -->
      <button id="btnConfigAlertas" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
       üîî Configurar Alertas
   </button>
   <!-- NUEVO: Bot√≥n de vista calendario -->
<button id="btnVistaCalendario" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition-colors">
  üìÖ Vista Calendario
</button>
    </div>
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium">Filtrar por estado:</label>
        <select id="filtroMetricas" class="p-2 border rounded-lg">
          <option value="todos">Todos</option>
          <option value="activas">Solo activas</option>
          <option value="finalizadas">Solo finalizadas</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium">Vista tabla:</label>
        <select id="filtroTabla" class="p-2 border rounded-lg">
          <option value="alertas">Solo alertas</option>
          <option value="todas">Todas las tareas</option>
        </select>
      </div>
    </div>
  </div>
    <!-- KPIs Principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="metric-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm font-medium">Total Tareas</p>
            <p class="kpi-number text-blue-600" id="totalTareas">0</p>
          </div>
          <div class="text-blue-500 text-3xl">üìã</div>
        </div>
      </div>

      <div class="metric-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm font-medium">En Plazo</p>
            <p class="kpi-number text-green-600" id="enPlazo">0</p>
          </div>
          <div class="text-green-500 text-3xl">üü¢</div>
        </div>
      </div>

      <div class="metric-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm font-medium">Vencidas</p>
            <p class="kpi-number text-red-600" id="vencidas">0</p>
          </div>
          <div class="text-red-500 text-3xl">üî¥</div>
        </div>
      </div>

      <div class="metric-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm font-medium">Finalizadas</p>
            <p class="kpi-number text-purple-600" id="finalizadas">0</p>
          </div>
          <div class="text-purple-500 text-3xl">üîµ</div>
        </div>
      </div>
    </div>
    <!-- Gr√°ficos Principales -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Distribuci√≥n por Estado -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-bold mb-4 text-gray-800">üìä Distribuci√≥n por Estado</h3>
        <div class="relative" style="height: 300px;">
          <canvas id="estadosChart"></canvas>
        </div>
      </div>

      <!-- Carga de Trabajo por Rol -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-bold mb-4 text-gray-800">üë• Carga de Trabajo por Rol</h3>
        <div class="relative" style="height: 300px;">
          <canvas id="rolesChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Timeline de Deadlines -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <h3 class="text-lg font-bold mb-4 text-gray-800">üìÖ Timeline de Deadlines Pr√≥ximos</h3>
      <div id="timelineContainer" class="space-y-3">
        <!-- Se llena din√°micamente -->
      </div>
    </div>
    <!-- Tabla de Alertas -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <h3 class="text-lg font-bold mb-4 text-gray-800" id="tituloTabla">‚ö†Ô∏è Tareas que Requieren Atenci√≥n</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="tablaAlertas">
          <thead class="bg-gray-100">
            <tr>
              <th class="p-3 text-left">Tarea</th>
              <th class="p-3 text-center">Responsable</th>
              <th class="p-3 text-center">Deadline</th>
              <th class="p-3 text-center">D√≠as</th>
              <th class="p-3 text-center">Estado</th>
            </tr>
          </thead>
          <tbody id="alertasBody">
            <!-- Se llena din√°micamente -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- M√©tricas por Responsable -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h3 class="text-lg font-bold mb-4 text-gray-800">üìà M√©tricas por Responsable</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="metricasResponsables">
        <!-- Se llena din√°micamente -->
      </div>
    </div>
    <!-- NUEVO: Vista de Calendario (inicialmente oculta) -->
<div id="vistaCalendario" class="calendario-container hidden">
  <div class="calendario-header">
    <button id="btnMesAnterior" class="calendario-nav-btn">‚óÄ Anterior</button>
    <h3 id="calendarioTitulo" class="text-xl font-bold">Mayo 2025</h3>
    <button id="btnMesSiguiente" class="calendario-nav-btn">Siguiente ‚ñ∂</button>
  </div>
  
  <div class="calendario-grid" id="calendarioGrid">
    <!-- Se llena din√°micamente -->
  </div>
</div>
  </div>
  <script>
    // Variables globales
    let datosRASIC = [];
    let chartEstados = null;
    let chartRoles = null;
    let formatoExportacionSeleccionado = null;
    let configuracionAlertas = {
  habilitado: true,
  diasAviso: [3, 7, 14],
  notificacionesNavegador: true,
  sonido: false
};
let vistaActual = 'dashboard'; // 'dashboard' o 'calendario'
let fechaCalendarioActual = new Date();

    // Datos de ejemplo para pruebas
 const datosEjemplo = [
  {
    "id": "1",
    "tarea": "Definir arquitectura del sistema",
    "rasic": ["R", "A", "", "S", "I", ""],
    "fechaActual": "2025-01-15",
    "deadline": "2025-05-30",
    "tareaFinalizada": "No",
    "estado": "üü¢",
    "nuevoDeadline": ""
  },
  {
    "id": "2",
    "tarea": "Implementar base de datos",
    "rasic": ["", "A", "R", "", "S", ""],
    "fechaActual": "2025-01-15",
    "deadline": "2025-05-25",
    "tareaFinalizada": "No",
    "estado": "üü°",
    "nuevoDeadline": ""
  },
  {
    "id": "3",
    "tarea": "Dise√±o de interfaz de usuario",
    "rasic": ["S", "", "", "R", "I", "A"],
    "fechaActual": "2025-01-15",
    "deadline": "2025-05-22",
    "tareaFinalizada": "No",
    "estado": "üî¥",
    "nuevoDeadline": ""
  },
  {
    "id": "4",
    "tarea": "Testing y QA",
    "rasic": ["", "S", "I", "", "R", "A"],
    "fechaActual": "2025-01-15",
    "deadline": "2025-05-20",
    "tareaFinalizada": "Si",
    "estado": "üîµ",
    "nuevoDeadline": ""
  },
  {
    "id": "5",
    "tarea": "Documentaci√≥n t√©cnica",
    "rasic": ["", "", "R", "A", "", "S"],
    "fechaActual": "2025-01-15",
    "deadline": "2025-07-01",
    "tareaFinalizada": "No",
    "estado": "üü¢",
    "nuevoDeadline": ""
  }
];

    // Inicializar cuando se carga la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
  inicializarEventListeners();
  cargarDatosDesdeLocalStorage();
  
  // NUEVO: Cargar configuraci√≥n de alertas
  const configGuardada = localStorage.getItem('configuracionAlertas');
  if (configGuardada) {
    configuracionAlertas = JSON.parse(configGuardada);
  }
  
  if (datosRASIC.length === 0) {
    mostrarNotificacion("‚ÑπÔ∏è No hay datos. Usa 'Cargar Datos de Prueba' para ver el dashboard en acci√≥n.", "info");
  } else {
    actualizarDashboard();
    
    // NUEVO: Verificar alertas despu√©s de cargar datos
    setTimeout(() => {
      verificarAlertasProximas();
    }, 2000); // Esperar 2 segundos para que cargue todo
  }
});
    function inicializarEventListeners() {
      const btnActualizar = document.getElementById('btnActualizar');
      const btnCargarDatos = document.getElementById('btnCargarDatos');
      const filtroMetricas = document.getElementById('filtroMetricas');
      const filtroTabla = document.getElementById('filtroTabla');

      if (btnActualizar) {
        btnActualizar.addEventListener('click', actualizarDashboard);
      }

      if (btnCargarDatos) {
        btnCargarDatos.addEventListener('click', cargarDatosDePrueba);
      }

      if (filtroMetricas) {
        filtroMetricas.addEventListener('change', actualizarDashboard);
      }
      if (filtroTabla) {
        filtroTabla.addEventListener('change', actualizarDashboard);
   }
      const btnImprimir = document.getElementById('btnImprimir');
    if (btnImprimir) {
      btnImprimir.addEventListener('click', imprimirDashboard);
   }  
   // NUEVO: Event listeners para exportaci√≥n
    const btnExportar = document.getElementById('btnExportar');
    if (btnExportar) {
  btnExportar.addEventListener('click', mostrarModalExportacion);
}

    // Modal de exportaci√≥n
    document.getElementById('btnCerrarExport').addEventListener('click', cerrarModalExportacion);
    document.getElementById('btnEjecutarExport').addEventListener('click', ejecutarExportacion);

    // Opciones de exportaci√≥n
    document.querySelectorAll('.export-option').forEach(option => {
     option.addEventListener('click', function() {
    seleccionarFormatoExportacion(this.dataset.format);
  });
});
// NUEVO: Event listeners para configuraci√≥n de alertas
const btnConfigAlertas = document.getElementById('btnConfigAlertas');
if (btnConfigAlertas) {
  btnConfigAlertas.addEventListener('click', mostrarModalConfigAlertas);
}

// Modal de configuraci√≥n de alertas
document.getElementById('btnCerrarConfigAlertas').addEventListener('click', cerrarModalConfigAlertas);
document.getElementById('btnGuardarConfigAlertas').addEventListener('click', guardarConfiguracionAlertas);

// NUEVO: Event listeners para vista calendario
const btnVistaCalendario = document.getElementById('btnVistaCalendario');
if (btnVistaCalendario) {
  btnVistaCalendario.addEventListener('click', alternarVista);
}

// Navegaci√≥n del calendario
document.getElementById('btnMesAnterior').addEventListener('click', () => {
  fechaCalendarioActual.setMonth(fechaCalendarioActual.getMonth() - 1);
  actualizarCalendario();
});

document.getElementById('btnMesSiguiente').addEventListener('click', () => {
  fechaCalendarioActual.setMonth(fechaCalendarioActual.getMonth() + 1);
  actualizarCalendario();
});
    }

    function cargarDatosDesdeLocalStorage() {
      try {
        const data = localStorage.getItem("tablaTareasData");
        if (data) {
          datosRASIC = JSON.parse(data);
          console.log("Datos cargados desde localStorage:", datosRASIC.length, "tareas");
        } else {
          datosRASIC = [];
          console.log("No hay datos en localStorage");
        }
      } catch (error) {
        console.error("Error al cargar datos:", error);
        datosRASIC = [];
        mostrarNotificacion("‚ùå Error al cargar los datos", "error");
      }
    }

    function cargarDatosDePrueba() {
      datosRASIC = [...datosEjemplo];
      actualizarDashboard();
      mostrarNotificacion("‚úÖ Datos de prueba cargados correctamente", "success");
    }

    function actualizarDashboard() {
      try {
        const filtroElement = document.getElementById('filtroMetricas');
        const filtro = filtroElement ? filtroElement.value : 'todos';
        const datosFiltrados = filtrarDatos(datosRASIC, filtro);
        
        actualizarKPIs(datosFiltrados);
        actualizarGraficoEstados(datosFiltrados);
        actualizarGraficoRoles(datosFiltrados);
        actualizarTimeline(datosFiltrados);
        actualizarTablaAlertas(datosFiltrados);
        actualizarMetricasResponsables(datosFiltrados);
        
        const fechaElement = document.getElementById('fechaActualizacion');
        if (fechaElement) {
          fechaElement.textContent = new Date().toLocaleString();
        }
        
        mostrarNotificacion("‚úÖ Dashboard actualizado", "success");
      } catch (error) {
        console.error("Error al actualizar dashboard:", error);
        mostrarNotificacion("‚ùå Error al actualizar dashboard", "error");
      }
    }

    function filtrarDatos(datos, filtro) {
      if (!Array.isArray(datos)) return [];
      
      switch(filtro) {
        case 'activas':
          return datos.filter(t => t.tareaFinalizada !== 'Si');
        case 'finalizadas':
          return datos.filter(t => t.tareaFinalizada === 'Si');
        default:
          return datos;
      }
    }
    function actualizarKPIs(datos) {
      try {
        const total = datos.length;
        const enPlazo = datos.filter(t => t.estado === 'üü¢').length;
        const vencidas = datos.filter(t => t.estado === 'üî¥').length;
        const finalizadas = datos.filter(t => t.estado === 'üîµ').length;

        const elements = {
          totalTareas: document.getElementById('totalTareas'),
          enPlazo: document.getElementById('enPlazo'),
          vencidas: document.getElementById('vencidas'),
          finalizadas: document.getElementById('finalizadas')
        };

        if (elements.totalTareas) elements.totalTareas.textContent = total;
        if (elements.enPlazo) elements.enPlazo.textContent = enPlazo;
        if (elements.vencidas) elements.vencidas.textContent = vencidas;
        if (elements.finalizadas) elements.finalizadas.textContent = finalizadas;
      } catch (error) {
        console.error("Error al actualizar KPIs:", error);
      }
    }

    function actualizarGraficoEstados(datos) {
      try {
        const canvas = document.getElementById('estadosChart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        
        if (chartEstados) {
          chartEstados.destroy();
          chartEstados = null;
        }

        const estados = {
          'En plazo': datos.filter(t => t.estado === 'üü¢').length,
          'Pr√≥ximo a vencer': datos.filter(t => t.estado === 'üü°').length,
          'Vencidas': datos.filter(t => t.estado === 'üî¥').length,
          'Finalizadas': datos.filter(t => t.estado === 'üîµ').length,
          'Sin fecha': datos.filter(t => t.estado === '‚ö™' || !t.estado).length
        };

        chartEstados = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(estados),
            datasets: [{
              data: Object.values(estados),
              backgroundColor: [
                '#10B981', // Verde
                '#F59E0B', // Amarillo
                '#EF4444', // Rojo
                '#3B82F6', // Azul
                '#9CA3AF'  // Gris
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      } catch (error) {
        console.error("Error al crear gr√°fico de estados:", error);
      }
    }
    function actualizarGraficoRoles(datos) {
      try {
        const canvas = document.getElementById('rolesChart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        
        if (chartRoles) {
          chartRoles.destroy();
          chartRoles = null;
        }

        const roles = ['CEO', 'PMO', 'Finanzas', 'Advisor', 'Tozzini F.', 'Paralegal'];
        const conteoRoles = {};

        roles.forEach(rol => {
          conteoRoles[rol] = 0;
        });

        datos.forEach(tarea => {
          if (tarea.rasic && Array.isArray(tarea.rasic)) {
            tarea.rasic.forEach((valor, index) => {
              if (valor && valor !== '' && index < roles.length) {
                conteoRoles[roles[index]]++;
              }
            });
          }
        });

        chartRoles = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: roles,
            datasets: [{
              label: 'Tareas asignadas',
              data: Object.values(conteoRoles),
              backgroundColor: [
                '#3B82F6', '#10B981', '#F59E0B', 
                '#EF4444', '#8B5CF6', '#06B6D4'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      } catch (error) {
        console.error("Error al crear gr√°fico de roles:", error);
      }
    }

    function actualizarTimeline(datos) {
      try {
        const container = document.getElementById('timelineContainer');
        if (!container) return;

        container.innerHTML = '';

      // Filtrar tareas con deadline
      const tareasConDeadline = datos
          .filter(t => t.deadline)
          .sort((a, b) => new Date(a.deadline) - new Date(b.deadline))
          .slice(0, 10); // Solo las pr√≥ximas 10

        if (tareasConDeadline.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay deadlines pr√≥ximos</p>';
          return;
        }

        tareasConDeadline.forEach(tarea => {
          const deadline = new Date(tarea.deadline);
          const hoy = new Date();
          const diasRestantes = Math.ceil((deadline - hoy) / (1000 * 60 * 60 * 24));
          
          let colorClase = 'bg-gray-100';
          let estadoTexto = 'Sin estado';

          if (tarea.estado === 'üü¢') {
           colorClase = 'bg-green-100 border-l-4 border-green-500';
           estadoTexto = 'En plazo';
         } else if (tarea.estado === 'üü°') {
          colorClase = 'bg-yellow-100 border-l-4 border-yellow-500';
          estadoTexto = 'Pr√≥ximo a vencer';
        } else if (tarea.estado === 'üî¥') {
  colorClase = 'bg-red-100 border-l-4 border-red-500';
  estadoTexto = 'Vencida';
} else if (tarea.estado === 'üîµ') {
          colorClase = 'bg-blue-100 border-l-4 border-blue-500';
          estadoTexto = 'Finalizada';
        }

          const item = document.createElement('div');
          item.className = `${colorClase} p-4 rounded-lg`;
          item.innerHTML = `
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-2">
              <div class="flex-1">
                <h4 class="font-semibold text-sm">${(tarea.tarea || '').substring(0, 80)}${(tarea.tarea || '').length > 80 ? '...' : ''}</h4>
                <p class="text-xs text-gray-600 mt-1">
                  ${deadline.toLocaleDateString()} ‚Ä¢ ${estadoTexto}
                </p>
              </div>
              <div class="text-right">
                <span class="inline-block px-2 py-1 rounded text-xs font-medium ${
                  tarea.estado === 'üî¥' ? 'bg-red-200 text-red-800' :
                  tarea.estado === 'üü°' ? 'bg-yellow-200 text-yellow-800' :
                  tarea.estado === 'üü¢' ? 'bg-green-200 text-green-800' :
                  tarea.estado === 'üîµ' ? 'bg-blue-200 text-blue-800' :
              'bg-gray-200 text-gray-800'   
                }">
                  ${diasRestantes < 0 ? `${Math.abs(diasRestantes)} d√≠as atr√°s` : 
                    diasRestantes === 0 ? 'Hoy' : `${diasRestantes} d√≠as`}
                </span>
              </div>
            </div>
          `;
          container.appendChild(item);
        });
      } catch (error) {
        console.error("Error al actualizar timeline:", error);
      }
    }
    function actualizarTablaAlertas(datos) {
  try {
    const tbody = document.getElementById('alertasBody');
    const titulo = document.getElementById('tituloTabla');
    const filtroTablaElement = document.getElementById('filtroTabla');
    
    if (!tbody) return;

    tbody.innerHTML = '';

    const filtroTabla = filtroTablaElement ? filtroTablaElement.value : 'alertas';
    let tareasAMostrar = [];

    if (filtroTabla === 'todas') {
      // Mostrar todas las tareas
      tareasAMostrar = datos.sort((a, b) => {
        // Ordenar por estado (rojas primero, luego amarillas, luego verdes, luego azules)
        const prioridadEstado = { 'üî¥': 1, 'üü°': 2, 'üü¢': 3, 'üîµ': 4 };
        const prioridadA = prioridadEstado[a.estado] || 5;
        const prioridadB = prioridadEstado[b.estado] || 5;
        
        if (prioridadA !== prioridadB) return prioridadA - prioridadB;
        return new Date(a.deadline || '9999-12-31') - new Date(b.deadline || '9999-12-31');
      });
      
      if (titulo) titulo.textContent = 'üìã Todas las Tareas';
    } else {
      // Mostrar solo alertas (rojas y amarillas) que NO est√©n finalizadas
      tareasAMostrar = datos
        .filter(t => (t.estado === 'üî¥' || t.estado === 'üü°') && t.tareaFinalizada !== 'Si')
        .sort((a, b) => {
          if (a.estado === 'üî¥' && b.estado !== 'üî¥') return -1;
          if (b.estado === 'üî¥' && a.estado !== 'üî¥') return 1;
          return new Date(a.deadline || '9999-12-31') - new Date(b.deadline || '9999-12-31');
        });
      
      if (titulo) titulo.textContent = '‚ö†Ô∏è Tareas que Requieren Atenci√≥n';
    }

    if (tareasAMostrar.length === 0) {
      const mensaje = filtroTabla === 'todas' ? 'No hay tareas para mostrar' : 'No hay tareas que requieran atenci√≥n inmediata';
      tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">${mensaje}</td></tr>`;
      return;
    }

    tareasAMostrar.forEach(tarea => {
      const responsable = obtenerResponsablePrincipal(tarea.rasic);
      const deadline = tarea.deadline ? new Date(tarea.deadline) : null;
      const diasRestantes = deadline ? Math.ceil((deadline - new Date()) / (1000 * 60 * 60 * 24)) : null;

      const fila = document.createElement('tr');
      let colorFila = 'bg-gray-50';
      if (tarea.estado === 'üî¥') colorFila = 'bg-red-50';
      else if (tarea.estado === 'üü°') colorFila = 'bg-yellow-50';
      else if (tarea.estado === 'üü¢') colorFila = 'bg-green-50';
      else if (tarea.estado === 'üîµ') colorFila = 'bg-blue-50';
      
      fila.className = colorFila; 
      fila.innerHTML = `
        <td class="p-3">${(tarea.tarea || '').substring(0, 50)}${(tarea.tarea || '').length > 50 ? '...' : ''}</td>
        <td class="p-3 text-center">${responsable}</td>
        <td class="p-3 text-center">${deadline ? deadline.toLocaleDateString() : 'N/A'}</td>
        <td class="p-3 text-center">
          <span class="px-2 py-1 rounded text-xs ${
            tarea.estado === 'üî¥' ? 'bg-red-200 text-red-800' :
            tarea.estado === 'üü°' ? 'bg-yellow-200 text-yellow-800' :
            tarea.estado === 'üü¢' ? 'bg-green-200 text-green-800' :
            tarea.estado === 'üîµ' ? 'bg-blue-200 text-blue-800' :
            'bg-gray-200 text-gray-800' 
          }">
            ${diasRestantes === null ? 'N/A' :
              diasRestantes < 0 ? Math.abs(diasRestantes) + ' d√≠as atr√°s' : 
              diasRestantes === 0 ? 'Hoy' : diasRestantes + ' d√≠as'}
          </span>
        </td>
        <td class="p-3 text-center text-lg">${tarea.estado || '‚ö™'}</td>
      `;
      tbody.appendChild(fila);
    });
  } catch (error) {
    console.error("Error al actualizar tabla de alertas:", error);
  }
}

    function actualizarMetricasResponsables(datos) {
      try {
        const container = document.getElementById('metricasResponsables');
        if (!container) return;

        container.innerHTML = '';

        const roles = ['CEO', 'PMO', 'Finanzas', 'Advisor', 'Tozzini F.', 'Paralegal'];
        
        roles.forEach((rol, index) => {
          const tareasRol = datos.filter(t => t.rasic && t.rasic[index] && t.rasic[index] !== '');
          const total = tareasRol.length;
          const finalizadas = tareasRol.filter(t => t.tareaFinalizada === 'Si').length;
          const vencidas = tareasRol.filter(t => t.estado === 'üî¥').length;
          const porcentajeCompletado = total > 0 ? Math.round((finalizadas / total) * 100) : 0;

          const card = document.createElement('div');
          card.className = 'bg-gray-50 p-4 rounded-lg border';
          card.innerHTML = `
            <h4 class="font-semibold text-sm mb-3">${rol}</h4>
            <div class="space-y-2">
              <div class="flex justify-between text-xs">
                <span>Total tareas:</span>
                <span class="font-medium">${total}</span>
              </div>
              <div class="flex justify-between text-xs">
                <span>Finalizadas:</span>
                <span class="font-medium text-green-600">${finalizadas}</span>
              </div>
              <div class="flex justify-between text-xs">
                <span>Vencidas:</span>
                <span class="font-medium text-red-600">${vencidas}</span>
              </div>
              <div class="flex justify-between text-xs">
                <span>% Completado:</span>
                <span class="font-medium">${porcentajeCompletado}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                <div class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: ${porcentajeCompletado}%"></div>
              </div>
            </div>
          `;
          container.appendChild(card);
        });
      } catch (error) {
        console.error("Error al actualizar m√©tricas de responsables:", error);
      }
    }
    function obtenerResponsablePrincipal(rasic) {
      if (!rasic || !Array.isArray(rasic)) return 'N/A';
      
      const roles = ['CEO', 'PMO', 'Finanzas', 'Advisor', 'TF', 'Paralegal'];
      
      // Buscar R (Responsible) primero
      for (let i = 0; i < rasic.length && i < roles.length; i++) {
        if (rasic[i] === 'R') {
          return roles[i];
        }
      }
      
      // Buscar A (Accountable) como alternativa
      for (let i = 0; i < rasic.length && i < roles.length; i++) {
        if (rasic[i] === 'A') {
          return roles[i];
        }
      }
      
      return 'N/A';
    }

    function mostrarNotificacion(mensaje, tipo = "info") {
      const colores = {
        success: "bg-green-500",
        error: "bg-red-500",
        warning: "bg-yellow-500",
        info: "bg-blue-500"
      };
      
      const existente = document.querySelector(".notificacion-toast");
      if (existente) {
        existente.remove();
      }
      
      const notificacion = document.createElement("div");
      notificacion.className = `fixed bottom-4 right-4 ${colores[tipo]} text-white p-3 rounded-lg shadow-lg z-50 notificacion-toast`;
      notificacion.textContent = mensaje;
      
      document.body.appendChild(notificacion);
      
      setTimeout(() => {
        if (notificacion.parentNode) {
          notificacion.style.opacity = '0';
          notificacion.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (notificacion.parentNode) {
              notificacion.remove();
            }
          }, 300);
        }
      }, 3000);
    }

function imprimirDashboard() {
  try {
    // Actualizar fecha de impresi√≥n
    const fechaElement = document.getElementById('fechaActualizacion');
    if (fechaElement) {
      fechaElement.textContent = new Date().toLocaleString();
    }
    
    // A√±adir informaci√≥n de impresi√≥n al header
    const header = document.querySelector('header p');
    const textoOriginal = header.innerHTML;
    header.innerHTML = `Dashboard impreso el ${new Date().toLocaleDateString()} a las ${new Date().toLocaleTimeString()}`;
    
    // Imprimir
    window.print();
    
    // Restaurar texto original despu√©s de imprimir
    setTimeout(() => {
      header.innerHTML = textoOriginal;
    }, 1000);
    
    mostrarNotificacion("üñ®Ô∏è Preparando impresi√≥n del dashboard...", "info");
  } catch (error) {
    console.error("Error al imprimir:", error);
    mostrarNotificacion("‚ùå Error al preparar impresi√≥n", "error");
  }
}

// NUEVAS FUNCIONES DE EXPORTACI√ìN
function mostrarModalExportacion() {
  document.getElementById('modalExportacion').classList.remove('hidden');
  document.getElementById('modalExportacion').classList.add('flex');
  formatoExportacionSeleccionado = null;
  actualizarBotonExportar();
}

function cerrarModalExportacion() {
  document.getElementById('modalExportacion').classList.add('hidden');
  document.getElementById('modalExportacion').classList.remove('flex');
  
  document.querySelectorAll('.export-option').forEach(option => {
    option.classList.remove('selected');
  });
}

function seleccionarFormatoExportacion(formato) {
  document.querySelectorAll('.export-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  document.querySelector(`[data-format="${formato}"]`).classList.add('selected');
  formatoExportacionSeleccionado = formato;
  actualizarBotonExportar();
}

function actualizarBotonExportar() {
  const boton = document.getElementById('btnEjecutarExport');
  if (formatoExportacionSeleccionado) {
    boton.disabled = false;
    boton.textContent = `Exportar ${getFormatoTexto(formatoExportacionSeleccionado)}`;
  } else {
    boton.disabled = true;
    boton.textContent = 'Exportar';
  }
}

function getFormatoTexto(formato) {
  const formatos = {
    'excel': 'Excel',
    'csv': 'CSV', 
    'summary': 'Resumen'
  };
  return formatos[formato] || 'Datos';
}

function ejecutarExportacion() {
  if (!formatoExportacionSeleccionado) return;

  try {
    const filtroElement = document.getElementById('filtroMetricas');
    const filtro = filtroElement ? filtroElement.value : 'todos';
    const datosFiltrados = filtrarDatos(datosRASIC, filtro);

    switch (formatoExportacionSeleccionado) {
      case 'excel':
        exportarExcel(datosFiltrados);
        break;
      case 'csv':
        exportarCSV(datosFiltrados);
        break;
      case 'summary':
        exportarResumenEjecutivo(datosFiltrados);
        break;
    }

    cerrarModalExportacion();
    mostrarNotificacion(`‚úÖ Datos exportados en formato ${getFormatoTexto(formatoExportacionSeleccionado)}`, "success");
  } catch (error) {
    console.error("Error al exportar:", error);
    mostrarNotificacion("‚ùå Error al exportar datos", "error");
  }
}

function exportarExcel(datos) {
  const wb = XLSX.utils.book_new();
  
  // Datos de tareas
  const wsData = [['Tarea', 'CEO', 'PMO', 'Finanzas', 'Advisor', 'Tozzini F.', 'Paralegal', 'Fecha Actual', 'Deadline', 'Finalizada', 'Estado']];
  
  datos.forEach(tarea => {
    wsData.push([
      tarea.tarea || '',
      tarea.rasic?.[0] || '',
      tarea.rasic?.[1] || '',
      tarea.rasic?.[2] || '',
      tarea.rasic?.[3] || '',
      tarea.rasic?.[4] || '',
      tarea.rasic?.[5] || '',
      tarea.fechaActual || '',
      tarea.deadline || '',
      tarea.tareaFinalizada || 'No',
      getEstadoTexto(tarea.estado)
    ]);
  });
  
  const ws1 = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws1, "Tareas");
  
  const fecha = new Date().toISOString().split('T')[0];
  XLSX.writeFile(wb, `Dashboard_RASIC_${fecha}.xlsx`);
}

function exportarCSV(datos) {
  let csv = 'Tarea,CEO,PMO,Finanzas,Advisor,Tozzini F.,Paralegal,Fecha Actual,Deadline,Finalizada,Estado\n';
  
  datos.forEach(tarea => {
    const fila = [
      `"${(tarea.tarea || '').replace(/"/g, '""')}"`,
      tarea.rasic?.[0] || '',
      tarea.rasic?.[1] || '',
      tarea.rasic?.[2] || '',
      tarea.rasic?.[3] || '',
      tarea.rasic?.[4] || '',
      tarea.rasic?.[5] || '',
      tarea.fechaActual || '',
      tarea.deadline || '',
      tarea.tareaFinalizada || 'No',
      getEstadoTexto(tarea.estado)
    ];
    csv += fila.join(',') + '\n';
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const fecha = new Date().toISOString().split('T')[0];
  
  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `Tareas_RASIC_${fecha}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}

function exportarResumenEjecutivo(datos) {
  const total = datos.length;
  const enPlazo = datos.filter(t => t.estado === 'üü¢').length;
  const vencidas = datos.filter(t => t.estado === 'üî¥').length;
  const finalizadas = datos.filter(t => t.estado === 'üîµ').length;
  
  let resumen = `RESUMEN EJECUTIVO - Dashboard RASIC Halotech\n`;
  resumen += `Fecha: ${new Date().toLocaleDateString()}\n\n`;
  resumen += `=== M√âTRICAS PRINCIPALES ===\n`;
  resumen += `‚Ä¢ Total de tareas: ${total}\n`;
  resumen += `‚Ä¢ Tareas en plazo: ${enPlazo} (${Math.round((enPlazo / total) * 100)}%)\n`;
  resumen += `‚Ä¢ Tareas vencidas: ${vencidas} (${Math.round((vencidas / total) * 100)}%)\n`;
  resumen += `‚Ä¢ Tareas finalizadas: ${finalizadas} (${Math.round((finalizadas / total) * 100)}%)\n`;
  
  const blob = new Blob([resumen], { type: 'text/plain;charset=utf-8;' });
  const link = document.createElement('a');
  const fecha = new Date().toISOString().split('T')[0];
  
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', `Resumen_RASIC_${fecha}.txt`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function getEstadoTexto(estado) {
  const estados = {
    "üü¢": "En plazo",
    "üü°": "Pr√≥ximo a vencer", 
    "üî¥": "Vencida",
    "üîµ": "Finalizada",
    "‚ö™": "Sin fecha"
  };
  return estados[estado] || "Sin estado";
}
// NUEVAS FUNCIONES DE ALERTAS

function mostrarModalConfigAlertas() {
  document.getElementById('modalConfigAlertas').classList.remove('hidden');
  document.getElementById('modalConfigAlertas').classList.add('flex');
  cargarConfiguracionActual();
}

function cerrarModalConfigAlertas() {
  document.getElementById('modalConfigAlertas').classList.add('hidden');
  document.getElementById('modalConfigAlertas').classList.remove('flex');
}

function cargarConfiguracionActual() {
  // Cargar configuraci√≥n desde localStorage
  const config = JSON.parse(localStorage.getItem('configuracionAlertas')) || configuracionAlertas;
  
  // Activar/desactivar alertas
  document.getElementById('switchAlertas').checked = config.habilitado;
  
  // D√≠as de aviso
  document.querySelectorAll('input[value="3"], input[value="7"], input[value="14"]').forEach(checkbox => {
    checkbox.checked = config.diasAviso.includes(parseInt(checkbox.value));
  });
  
  // Tipo de notificaciones
  document.getElementById('checkNotifNavegador').checked = config.notificacionesNavegador;
  document.getElementById('checkSonido').checked = config.sonido;
}

function guardarConfiguracionAlertas() {
  // Recoger configuraci√≥n del modal
  const nuevaConfig = {
    habilitado: document.getElementById('switchAlertas').checked,
    diasAviso: [],
    notificacionesNavegador: document.getElementById('checkNotifNavegador').checked,
    sonido: document.getElementById('checkSonido').checked
  };
  
  // Recoger d√≠as seleccionados
  document.querySelectorAll('input[value="3"], input[value="7"], input[value="14"]').forEach(checkbox => {
    if (checkbox.checked) {
      nuevaConfig.diasAviso.push(parseInt(checkbox.value));
    }
  });
  
  // Guardar en variables globales y localStorage
  configuracionAlertas = nuevaConfig;
  localStorage.setItem('configuracionAlertas', JSON.stringify(nuevaConfig));
  
  // Solicitar permisos de notificaci√≥n si est√°n habilitadas
  if (nuevaConfig.notificacionesNavegador && nuevaConfig.habilitado) {
    solicitarPermisoNotificaciones();
  }
  
  cerrarModalConfigAlertas();
  mostrarNotificacion("‚úÖ Configuraci√≥n de alertas guardada", "success");
  
  // Verificar alertas inmediatamente
  verificarAlertasProximas();
}

function solicitarPermisoNotificaciones() {
  if ("Notification" in window) {
    if (Notification.permission === "default") {
      Notification.requestPermission().then(function (permission) {
        if (permission === "granted") {
          mostrarNotificacion("üîî Notificaciones activadas correctamente", "success");
        } else {
          mostrarNotificacion("‚ö†Ô∏è Permisos de notificaci√≥n denegados", "warning");
        }
      });
    }
  } else {
    mostrarNotificacion("‚ö†Ô∏è Este navegador no soporta notificaciones", "warning");
  }
}

function verificarAlertasProximas() {
  if (!configuracionAlertas.habilitado) return;
  
  const alertasEncontradas = [];
  const hoy = new Date();
  
  datosRASIC.forEach(tarea => {
    // Solo verificar tareas activas (no finalizadas)
    if (tarea.tareaFinalizada === 'Si' || !tarea.deadline) return;
    
    const deadline = new Date(tarea.deadline);
    const diasRestantes = Math.ceil((deadline - hoy) / (1000 * 60 * 60 * 24));
    
    // Verificar si est√° en los d√≠as de aviso configurados
    if (configuracionAlertas.diasAviso.includes(diasRestantes)) {
      alertasEncontradas.push({
        tarea: tarea.tarea,
        dias: diasRestantes,
        responsable: obtenerResponsablePrincipal(tarea.rasic)
      });
    }
  });
  
  // Mostrar alertas encontradas
  if (alertasEncontradas.length > 0) {
    mostrarAlertas(alertasEncontradas);
  }
}

function mostrarAlertas(alertas) {
  // Notificaci√≥n del navegador
  if (configuracionAlertas.notificacionesNavegador && "Notification" in window && Notification.permission === "granted") {
    alertas.forEach(alerta => {
      const mensaje = alerta.dias === 0 ? 
        `¬°Tarea vence HOY!` : 
        `Tarea vence en ${alerta.dias} d√≠a${alerta.dias > 1 ? 's' : ''}`;
        
      new Notification(`üîî RASIC Halotech - ${mensaje}`, {
        body: `${alerta.tarea.substring(0, 100)}... (Responsable: ${alerta.responsable})`,
        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzM5ODBGRiIvPgo8dGV4dCB4PSI1IiB5PSIyMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmaWxsPSJ3aGl0ZSI+UjwvdGV4dD4KPC9zdmc+',
        tag: `rasic-alert-${alerta.tarea.substring(0, 20)}`
      });
    });
  }
  
  // Sonido de alerta (opcional)
  if (configuracionAlertas.sonido) {
    reproducirSonidoAlerta();
  }
  
  // Notificaci√≥n en pantalla
  const totalAlertas = alertas.length;
  const mensaje = totalAlertas === 1 ? 
    `üîî 1 tarea requiere atenci√≥n` : 
    `üîî ${totalAlertas} tareas requieren atenci√≥n`;
  
  mostrarNotificacion(mensaje, "warning");
}

function reproducirSonidoAlerta() {
  // Crear un beep simple usando Web Audio API
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
  } catch (error) {
    console.log("No se pudo reproducir el sonido de alerta:", error);
  }
}
// NUEVAS FUNCIONES DE CALENDARIO

function alternarVista() {
  const vistaDashboard = document.querySelectorAll('.bg-white.p-6.rounded-xl.shadow-lg, .grid.grid-cols-1');
  const vistaCalendario = document.getElementById('vistaCalendario');
  const boton = document.getElementById('btnVistaCalendario');
  
  if (vistaActual === 'dashboard') {
    // Cambiar a vista calendario
    vistaDashboard.forEach(elemento => {
      if (!elemento.closest('#modalExportacion') && !elemento.closest('#modalConfigAlertas')) {
        elemento.style.display = 'none';
      }
    });
    
    vistaCalendario.classList.remove('hidden');
    boton.textContent = 'üìä Vista Dashboard';
    boton.className = 'bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors';
    vistaActual = 'calendario';
    
    actualizarCalendario();
  } else {
    // Cambiar a vista dashboard
    vistaDashboard.forEach(elemento => {
      elemento.style.display = '';
    });
    
    vistaCalendario.classList.add('hidden');
    boton.textContent = 'üìÖ Vista Calendario';
    boton.className = 'bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition-colors';
    vistaActual = 'dashboard';
  }
}

function actualizarCalendario() {
  const grid = document.getElementById('calendarioGrid');
  const titulo = document.getElementById('calendarioTitulo');
  
  if (!grid || !titulo) return;
  
  // Actualizar t√≠tulo
  const meses = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
  ];
  
  titulo.textContent = `${meses[fechaCalendarioActual.getMonth()]} ${fechaCalendarioActual.getFullYear()}`;
  
  // Limpiar grid
  grid.innerHTML = '';
  
  // A√±adir headers de d√≠as
  const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
  diasSemana.forEach(dia => {
    const header = document.createElement('div');
    header.className = 'calendario-dia-header';
    header.textContent = dia;
    grid.appendChild(header);
  });
  
  // Calcular d√≠as del mes
  const a√±o = fechaCalendarioActual.getFullYear();
  const mes = fechaCalendarioActual.getMonth();
  
  const primerDia = new Date(a√±o, mes, 1);
  const ultimoDia = new Date(a√±o, mes + 1, 0);
  const primerDiaSemana = primerDia.getDay();
  
  // D√≠as del mes anterior
  for (let i = primerDiaSemana - 1; i >= 0; i--) {
    const fecha = new Date(a√±o, mes, -i);
    crearDiaCalendario(fecha, true);
  }
  
  // D√≠as del mes actual
  for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
    const fecha = new Date(a√±o, mes, dia);
    crearDiaCalendario(fecha, false);
  }
  
  // D√≠as del mes siguiente para completar la semana
  const diasMostrados = primerDiaSemana + ultimoDia.getDate();
  const diasFaltantes = 42 - diasMostrados; // 6 semanas x 7 d√≠as
  
  for (let dia = 1; dia <= diasFaltantes; dia++) {
    const fecha = new Date(a√±o, mes + 1, dia);
    crearDiaCalendario(fecha, true);
  }
}

function crearDiaCalendario(fecha, otroMes) {
  const grid = document.getElementById('calendarioGrid');
  const hoy = new Date();
  
  const diaElemento = document.createElement('div');
  diaElemento.className = 'calendario-dia';
  
  if (otroMes) {
    diaElemento.classList.add('otro-mes');
  }
  
  // Marcar d√≠a actual
  if (fecha.toDateString() === hoy.toDateString()) {
    diaElemento.classList.add('hoy');
  }
  
  // N√∫mero del d√≠a
  const numero = document.createElement('div');
  numero.className = 'calendario-dia-numero';
  numero.textContent = fecha.getDate();
  diaElemento.appendChild(numero);
  
  // Buscar tareas para este d√≠a
  const fechaStr = fecha.toISOString().split('T')[0];
  const tareasDelDia = datosRASIC.filter(tarea => tarea.deadline === fechaStr);
  
  // Mostrar m√°ximo 3 tareas, el resto como "+X m√°s"
  const maxTareas = 3;
  tareasDelDia.slice(0, maxTareas).forEach(tarea => {
    const tareaElemento = document.createElement('div');
    tareaElemento.className = 'calendario-tarea';
    
    // A√±adir clase de color seg√∫n estado
    const colorClase = obtenerColorCalendario(tarea.estado);
    if (colorClase) {
      tareaElemento.classList.add(colorClase);
    }
    
    // Texto de la tarea (m√°ximo 25 caracteres)
    tareaElemento.textContent = (tarea.tarea || '').substring(0, 25);
    if ((tarea.tarea || '').length > 25) {
      tareaElemento.textContent += '...';
    }
    
    // Tooltip con informaci√≥n completa
    tareaElemento.title = `${tarea.tarea}\nResponsable: ${obtenerResponsablePrincipal(tarea.rasic)}\nEstado: ${getEstadoTexto(tarea.estado)}`;
    
    diaElemento.appendChild(tareaElemento);
  });
  
  // Mostrar "+X m√°s" si hay m√°s tareas
  if (tareasDelDia.length > maxTareas) {
    const masElemento = document.createElement('div');
    masElemento.className = 'calendario-mas-tareas';
    masElemento.textContent = `+${tareasDelDia.length - maxTareas} m√°s`;
    diaElemento.appendChild(masElemento);
  }
  
  // Event listener para click en d√≠a
  diaElemento.addEventListener('click', () => {
    mostrarDetallesDia(fecha, tareasDelDia);
  });
  
  grid.appendChild(diaElemento);
}

function obtenerColorCalendario(estado) {
  const colores = {
    'üü¢': 'verde',
    'üü°': 'amarillo', 
    'üî¥': 'rojo',
    'üîµ': 'azul'
  };
  return colores[estado] || '';
}

function mostrarDetallesDia(fecha, tareas) {
  if (tareas.length === 0) {
    mostrarNotificacion(`üìÖ No hay tareas para el ${fecha.toLocaleDateString()}`, "info");
    return;
  }
  
  const detalles = tareas.map(tarea => {
    const responsable = obtenerResponsablePrincipal(tarea.rasic);
    const estado = getEstadoTexto(tarea.estado);
    return `‚Ä¢ ${tarea.tarea} (${responsable} - ${estado})`;
  }).join('\n');
  
  alert(`üìÖ Tareas para ${fecha.toLocaleDateString()}:\n\n${detalles}`);
}
</script>

<!-- NUEVO: Modal de Exportaci√≥n -->
<div id="modalExportacion" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
<div class="bg-white rounded-lg shadow-xl p-6 m-4 w-full max-w-md">
  <h3 class="text-lg font-bold mb-4 text-gray-800">üì• Exportar Datos</h3>
  
  <div class="space-y-3 mb-6">
    <div class="export-option border-2 rounded-lg p-4" data-format="excel">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="font-semibold text-green-600">üìä Excel (.xlsx)</h4>
          <p class="text-sm text-gray-600">Incluye colores, m√©tricas y gr√°ficos</p>
        </div>
        <div class="text-2xl">‚úÖ</div>
      </div>
    </div>
    
    <div class="export-option border-2 rounded-lg p-4" data-format="csv">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="font-semibold text-blue-600">üìÑ CSV</h4>
          <p class="text-sm text-gray-600">Datos tabulares para an√°lisis</p>
        </div>
        <div class="text-2xl">üìä</div>
      </div>
    </div>
    
    <div class="export-option border-2 rounded-lg p-4" data-format="summary">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="font-semibold text-purple-600">üìã Resumen Ejecutivo</h4>
          <p class="text-sm text-gray-600">KPIs y m√©tricas principales</p>
        </div>
        <div class="text-2xl">üìà</div>
      </div>
    </div>
  </div>
  
  <div class="flex justify-end gap-3">
    <button id="btnCerrarExport" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
      Cancelar
    </button>
    <button id="btnEjecutarExport" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50" disabled>
      Exportar
    </button>
  </div>
</div>
</div>
<!-- NUEVO: Modal de Configuraci√≥n de Alertas -->
<div id="modalConfigAlertas" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl p-6 m-4 w-full max-w-lg">
    <h3 class="text-lg font-bold mb-4 text-gray-800">üîî Configuraci√≥n de Alertas</h3>
    
    <!-- Habilitar/Deshabilitar alertas -->
    <div class="mb-6 p-4 border rounded-lg">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="font-semibold">Activar Sistema de Alertas</h4>
          <p class="text-sm text-gray-600">Recibir notificaciones cuando las tareas est√©n pr√≥ximas a vencer</p>
        </div>
        <label class="switch">
          <input type="checkbox" id="switchAlertas" checked>
          <span class="slider"></span>
        </label>
      </div>
    </div>
    
    <!-- Configuraci√≥n de d√≠as de aviso -->
    <div class="mb-6">
      <h4 class="font-semibold mb-3">D√≠as de Aviso Anticipado</h4>
      <div class="space-y-2">
        <label class="alert-config-option flex items-center p-3 border rounded-lg">
          <input type="checkbox" class="mr-3" value="3" checked>
          <span>3 d√≠as antes del vencimiento</span>
        </label>
        <label class="alert-config-option flex items-center p-3 border rounded-lg">
          <input type="checkbox" class="mr-3" value="7" checked>
          <span>7 d√≠as antes del vencimiento</span>
        </label>
        <label class="alert-config-option flex items-center p-3 border rounded-lg">
          <input type="checkbox" class="mr-3" value="14" checked>
          <span>14 d√≠as antes del vencimiento</span>
        </label>
      </div>
    </div>
    
    <!-- Tipo de notificaciones -->
    <div class="mb-6">
      <h4 class="font-semibold mb-3">Tipo de Notificaciones</h4>
      <div class="space-y-2">
        <label class="alert-config-option flex items-center p-3 border rounded-lg">
          <input type="checkbox" id="checkNotifNavegador" class="mr-3" checked>
          <span>Notificaciones del navegador</span>
        </label>
        <label class="alert-config-option flex items-center p-3 border rounded-lg">
          <input type="checkbox" id="checkSonido" class="mr-3">
          <span>Sonido de alerta</span>
        </label>
      </div>
    </div>
    
    <div class="flex justify-end gap-3">
      <button id="btnCerrarConfigAlertas" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
        Cancelar
      </button>
      <button id="btnGuardarConfigAlertas" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
        Guardar Configuraci√≥n
      </button>
    </div>
  </div>
</div>
</body>
</html>
